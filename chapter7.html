<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>chapter7</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="chapterWrapper">
        <div class="sectionWrapper">
            <h1>NAT構築</h1>
            プライベートサブネットには配置したサーバーはインターネットから接続できないため安全です。
            <br>しかしインターネットと通信できないと、サーバーのアップデートやソフトウェアのインストールができない為不便です。
            <br>NATはその問題について解消するために、プライベートサブネット⇢インターネットの通信のみ許可する仕組みです
            <div class="sectionWrapper section1">
                <h2>NATの用途と必要性</h2>
                パブリックサブネット内にWebサーバーをプライベートサブネット内にDBサーバーをおいてます
                <br>現実的ではないですがscpコマンドでパブリックサブネット内のファイルを移していくことも可能と言ったら可能です
                <br>しかし手間がかかるのでNATを使いましょう
                <div class="itemWrapper">
                    <h3>NATの仕組み</h3>
                    NATはIPアドレスを変換する装置で２つのネットワークインターフェースを持ちます。
                    <br>片側のインターフェースには一般にパブリックIPアドレスを設定し、インターネットに接続可能な構成にしておきます
                    <br>もう片側にはプライベートIPアドレスを設定し、プライベートサブネットに接続します
                    <ol>
                        <li>プライベートサブネットに存在するホストがインターネットにパケットを送信しようとする</li>
                        <li>送信元IPアドレスをパブリックIPアドレスに変換</li>
                        <li>帰ってきたパケットがパブリックIPアドレスに来る</li>
                        <li>NATが応答パケットの宛先を変換してプライベートサブネットに転送します</li>
                        <li>インターネットとの通信が成功</li>
                    </ol>
                    サブネットにパブリックIPアドレスを割り当てるよりセキュリティが高まることがメリットです
                </div>
                <div class="box">
                    NATには２種類あって
                    <ul>
                        <li>IPアドレスのみを置換するもの</li>
                        <li>IPアドレスとポート番号の両方を置換するもの</li>
                    </ul>
                    後者の場合は一つのパブリックIPアドレスを複数のホストで共有して持つことができます。正確には後者はNAPTと呼ばれます
                    <br>そしてこのNAPTが使われる代表例が家庭にあるルーターです。
                    <br>プロバイダから割り当てられるパブリックIPアドレスが一つだけなので、それを複数のホストが共有して使うためにはNAPTの技術が必要です
                </div>
                このNATを構築する方法として、AWSではNATゲートウェイという機能が提供されており、非常に簡単にNATを利用することができます
            </div>
            <div class="itemWrapper">
                <h3>NATインスタンスとNATゲートウェイ</h3>
                AWSでNATを構成する場合、次の２つの方法があります
                <ul>
                    <li>NATインスタンス</li>
                    NATソフトウェアが予めインストールされたAMIから起動したEC2インスタンスを使う方法です。EC2インスタンスを作成するときにコミュニティAMIでami-vpc-natを選択してインストールするとNAT機能付きのEC2インスタンスを作れます
                    <br>NATインスタンスはAmazon LinuxをベースとしてLinuxOSなのでそのEC2インスタンスにNAT以外のソフトウェアをインストールすることもできます
                    <li>NATゲートウェイ</li>
                    NATゲートウェイはNAT専用に構成された仮想的なコンポーネントです
                    <br>配置するサブネットを選ぶだけで構成できます
                    <br>NATゲートウェイはNATインスタンスと違って負荷に応じてスケールアップします、
                    <br>料金は時間あたりと転送バイトの量によって決まります

                </ul>

            </div>
            <div class="itemWrapper">
                <h3>実際に構成してみよう</h3>
                大体のイメージとしては
                <br>
                DBサーバーのデフォルトゲートウェイをパブリックサブネットの中のNATゲートウェイ設定して
                <br>そのNATゲートウェイから外のインターネットに接続できるようにするという形です
                <br>
                <h4>実装</h4>
                
            </div>
            <div class="sectionWrapper">
                <h2>NATゲートウェイを構築する</h2>
                <div class="itemWrapper">
                    <h3>NATゲートウェイを起動する</h3>
                    まずはNATゲートウェイをサブネットに配置して起動します
                    <h4>手順</h4>
                    <ol>
                        <li>VPCのNATゲートウェイからNATゲートウェイの作成をクリックしてNATゲートウェイの作成を始めます</li>
                        <li>サブネットとElasticIPアドレスを割り当てる</li>
                        <li>NATゲートウェイの作成をクリックして作成完了
                        </li>
                    </ol>
                </div>
                <div class="itemWrapper">
                    <h3>ルートテーブルを更新する</h3>
                    簡単に言うとプライベートサブネットからインターネットに通信するとき、デフォルトゲートウェイをNATゲートウェイの方向にながれるように設定します
                    <h4>手順</h4>
                    <ol>
                        <li>NATゲートウェイのインスタンスIDを確認する（VPCメニューからNATゲートウェイのIDを確認する）</li>
                        <li>ルートテーブルを編集して、このプライベートサブネットのデフォルトゲートウェイをNATゲートウェイに変更します</li>
                        
                    </ol>
                </div>
            </div>
            <div class="sectionWrapper">
                <h2>NATゲートウェイを通じた疎通確認をする</h2>
                端的に言えば、プライベートサブネットからHTTP及びHTTPSの通信をして、NATゲートウェイが正常に作動しているかどうかを確認できます
                <div class="itemWrapper">
                    <h3>curlコマンドで確認する</h3>
                    ここでcurlコマンドはHTTPやFTPでファイルをダウンロードしたり、アップロードしたりするコマンドです
                    <br>
                    curl www.kantei.go.jp
                    <br>
                    これで首相官邸のHPの情報が取れてれば、HTTPで通信できていることがわかります
                    <div class="box">
                        <h4>NATゲートウェイの削除</h4>
                        NATゲートウェイを使う必要がなくなったら削除します。
                        <br>というのはNATゲートウェイは稼働時間と転送バイトの単位の療法で課金されるからです。
                        <br>通信していなくても、稼働していれば料金がかかります
                        <br>またNATゲートウェイを削除して於けばプライベートIPアドレスを持っているインスタンスがインターネットと勝手に通信することもないため、セキュリティ的にも安全です。
                        <br>
                        具体的にはこうやります
                        <ol>
                            <li>削除したいNATゲートウェイを選択</li>
                            <li>アクションメニューからNATゲートウェイの削除をクリックします</li>
                            <li>もう一度通信したくなったらNATゲートウェイを再作成するのですがそのときにNATゲートウェイのIDも変わるのでルートテーブルも編集する必要があります</li>
                            
                        </ol> 
                    </div>
                </div>

            </div>
            <div class="sectionWrapper">
                <h2>まとめ</h2>
                この章でNATゲートウェイを用いてプライベートサブネットからインターネットに接続する方法を説明しました。
                <br>NATゲートウェイを構成すればプライベートサブネットからでもインターネットに接続できるため、あたかもパブリックIPアドレスが割り当てられるような使い方ができます
                <br>しかもインターネットからプライベートサブネットには接続でないため、サーバーにパブリックIPを割り当てるよりも安全です
                <br>さてNATゲートウェイを構築したことでプライベートサブネットに配置されたDBサーバーでyumコマンドを使ってソフトウェアをインストールできるようになりました。
                <br>次章ではyumコマンドを使ってMariaDBをインストールします。
                <br>そしてWebサーバーにWordPressをインストールし、ブログサーバとして運用できるようにするところまでを說明します。
            </div>
        
        </div>
    </div>
</body>
</html>