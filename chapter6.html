<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="chapterWrapper chapter6">
    <h1>プライベートサブネットでDBの環境構築をする
    </h1>
    どんなにセキュリティ対策を撮っていても脆弱性は亡くならない
    <br>
    そこでインターネットから隔離したプライベートネットワークを作るのも一つのセキュリティ対策です
    <div class="sectionWrapper section1">
      <h2>プライベートサブネットの利点</h2>
      主にデータベースなどの外からのアクセスを必要としないようなバックエンドシステムはサブネットのプライベート中に入れてしまえばおけ
      <br>
      ここで自分が勘違いしそうになったポイントとしては、プライベートサブネットはほかのネットワークからの通信をすべて弾くのではなくて、インターネットからの通信を弾く、
      <br>
      つまり他のサブネットからの通信は受け入れる。
      <br>
      ていうかそうじゃないとサーバーのインストールとかできないし、存在しても意味ないよね
    </div>
    <div class="sectionWrapper section2">
      <h2>プライベートサブネットを作成する</h2>
      ここではプライベートサブネットをIPアドレス10.0.2.0/24 で作成します。
      <div class="itemWrapper">
        <h3>リージョンとアベイラビリティゾーンを確認する</h3>
        注意点としては、複数のサブネットを作成するときにそれぞれが違うアベイラビリティゾーンに属しているとき、つまりアベイラビリティゾーンをまたいでいるときに通信費用がかかります
        <br>

      </div>
      <div class="itemWrapper">
        <h3>プライベートサブネットを作成する</h3>
        サブネットの欄からサブネットの作成を選んで、プライベートサブネットという名前のサブネットでも作りまそう
        <br>
        このときにCIDRブロックは10.0.2.0/24ですよ
      </div>
      <div class="itemWrapper">
        <h3>ルートテーブルを確認する</h3>
        デフォルトでは自身のIPアドレスのみ適応されています。
        <br>
        しかし今回は自身とにおs通信のみしかする必要がないため、デフォルトのままでOK
      </div>
      <div class="itemWrapper">
        <h2>プライベートサブネットにサーバーを構築する</h2>
        <div class="itemWrapper">
          <h3>サーバーを構築する</h3>
          <ol><li>
            インスタンスを作成する
            <br>
            ここで補足：インスタンスとはネットワーク上に構成したOSをのせたサーバー環境のこと
            <br>
            覚えてたかな？
            <br>
            IPアドレスは自動割当じゃなくて無効化、サブネット設定を適応（無効）を選択する
          </li>
          <li>
            インスタンスの設定をDBように改良する
            <br>
            具体的にはセキュリティグループにmariaDBからの通信を通すように3306を許可するようにする
            <br>
            ちなみに今後はNATでセキュリティを確保するのでここでは受け付ける通信を任意の場所にシてしまっても良い（警告はでるがむししてOK）
            <br>
            <div class="box">ちなみにここで許可する通信元をセキュリティグループにすることも可能なので、今回で言えばWEB-SGにすることで同じことを実現することもできる</div>

          </li>

        </ol>
        </div>
        <div class="itemWrapper">
          <h3>確認する</h3>
          まずは作成したインスタンスのところにいって、それがパブリックDNSを持たないことを確認します。
          <br>
          以下では作成したインスタンスをDBサーバーと呼びます
          <br>
          <ol>
            <li>
              pingコマンドで疎通確認ができるようにする
              <br>pingコマンドではICMPと呼ばれるプロトコルを使用して、ネットワーク疎通を確認したホストに対して、ICMPエコー要求というパケットを送信します。それに対して、受け取ったホストは送信元に対してICMPエコー応答を返信します
              <br>これによってpingコマンドではパケットの疎通を確認したり、相手に届くまでの時間を計測したりします            </li>
            <li>
              ICMPが通るように構成する
              <div class="box">
                <h4>手順</h4>
                <ol>
                  <li>インバウンドの設定を始める</li>
                  セキュリティグループからDB−SGセキュリティグループをクリックして、インバウンドのファイアウォールのセキュリティ設定を編集します
                  <li>ルールの追加からすべてのICMP−IPv４を選択し、送信元には任意の場所を指定します</li>
                  <li>実際にpingコマンドを打って確認しましょう</li>
                  <li>ターミナルからウェブサーバーのDNS名を指定してSSHログインします</li>
                  <li>ping 10.0.2.10</li>
                  <li>ちなみにこれをローカルからも実行して、タイムアウトになることを確認することでセキュリティ的に問題がないことがわかります</li>
                  <li>また、これと同じことをウェブサーバーに対しても行うことでpingで疎通確認できるようになります</li>
                </ol>
              </div>
                     </ol>

        </div>
        <div class="itemWrapper">
          <h3>WEBサーバーを踏み台にしてDBサーバーにアクセスして、DBソフトをインストールする</h3>
          <ol>
            <li>秘密鍵をアップロードする</li>
            まずはカレントディレクトリにあるmy-key.pemファイルを時分のホームディレクトリに移します
            <br>
            scp -i my-key.pem my-key.pem ec2-user@ec2-13-114-53-177.ap-northeast-1.compute.amazonaws.com:~/
            <br>
            で打ちます
            <li>つぎに
              <br>chmod 400 my-key.pem
              <br>で秘密鍵のパーミッションを時分しか読めない設定ん変更します            </li>
            <li>DBサーバーSSHログインします</li>
            コマンドは<br>
            ssh -i my-key.pem ec2-user@10.0.2.10
            <br>です
          </ol>
        </div>
      
      </div>
      <div class="sectionWrapper section5">
        <h2>まとめ</h2>
        この翔ではインターネットから直接アクセスできないプライベートサブネットの扱い方を説明しました。
        <br>プライベートサブネットはプライベートIPアドレスしかないのでインターネットとの接続点を持ちません。
        <br>DBサーバーなどインターネットから隠したいサーバー群を配置するときに用います
        <br>こういったサブネットにアクセスするときにはそのサブネットにアクセスできるサブネットを踏み台にしてSSHでログインします
        <br>しかし依然としてプライベートサブネット内のサーバーからインターネットにアクセスすることはできません
        <br>ここで登場するのが<div class="red">NAT</div> 
        です。　
        <br>次章NATについてせつめいします。
      </div>
    </div>
  </div>

</body>
</html>
