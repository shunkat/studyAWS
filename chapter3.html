<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="chapterWrapper">
        <div id="chap3">
            <h1>サーバーを構築する</h1>
            <div class="introOfChap3">
                パブリックサブネットの中に仮想サーバーを構築します
                <br>
                仮想サーバーを作成するときにはAmazonEC2を用いて作成します。<br>
                作成した仮想サーバーのことをここでは
                <strong class="red">インスタンス</strong>
                と呼びます<br>
                <div class="box">
                    <h3>作成手順</h3>
                    リージョンが東京になっていることを念の為確認します
                    <br>
                    ⇢インスタンスの起動を押して<br>
                    ⇢AMIであるAmazon Linux 2 AMIを選択します：ここでAMIとはインスタンスを起動する際に用いるイメージファイルのことでOSや初期アカウントの設定が済んでいるものです<br>
                    ⇢インスタンスタイプであるマイクロインスタンスを選択します：マイクロインスタンスはAWSの無料枠の中にはいっているやつです<br>
                    ⇢インスタンスの詳細設定ボタンをクリックします<br>
                    <ol>
                        <li>VPC領域を全章で作成したものに、その後のサブネットの選択も全章で選択したものに</li>
                        <li>インターネットからこのインスタンスにアクセスできるようにするためにパブリックIPアドレスを付与します。具体的には自動割当パブリックIPを有効にします</li>
                        <li class="green">プライベートIPアドレスも設定します、なんでかわからんけどプライベートアドレスはパブリックサブネットで指定している範囲で指定できるそうです。パブリックとプライベート逆になってないか？
                            <br>まぁともかくネットワークインターフェースのプライマリIPに10.0.1.10と入力します
                        </li>
                        <li>ストレージの追加を押して、使用する仮想ハードディスクをデフォルトのままに設定します</li>
                        <li>タグの追加を押して、インスタンスに名前をつけます。今はWebサーバーとデモしておきましょう</li>
                        <li>セキュリティを追加します。ここではWEB-SGという名前に設定してほかはデフォルトでいいでしょう。警告はこのボックスの下で詳しく説明します</li>
                        <li>インスタンスの起動を押します</li>
                        <li>最後にキーペアを作成してダウンロードします。ここではmy-keyとします</li>
                        <li>インスタンスを起動して、インスタンスの表示ボタンから確認します</li>
                        <li>インスタンス一覧画面からインスタンスが実行中になっていること、ステータスチェックが2／2合格しました担っていることを確認します</li>
                        <strong>以上です</strong>



                    </ol>
                </div>
            ※デフォルトのセキュリティグループの設定ではSSHというプロトコルでどこからでも接続できます
            <br>
            SSHはサーバーにリモートでログインして各種操作をするときに用いるもので、どこからでもアクセスできると危険です。
            <br>
            なのでAWSではその状態だと警告が出るようにしています。本来ならインスタンスを管理する自分のパソコンのIPアドレスからのみ制限するといいでしょう
            <br>
            それ以外にも「マイIP」を選択すると今AWSマネジメントコンソールで操作しているパソコンのパブリックIPアドレスが設定されてそのパソコンからしか接続できなくなります
            <br>
            <span class="red">しかし</span>
            これにも問題があり、日本の多くのプロバイダーが採用している動的IPアドレスだと頻繁にIPアドレスが変わり再接続できなくなってしまう可能性があるのです。
            <div class="box">
                <h4>インスタンスの停止と再開と破棄</h4>
                インスタンスを利用していないときは停止すると課金対象から外れます
                <br>
                ただしインスタンスが用いているストレージであるAmazon Elastic Block Store(EBS)はインスタンスが停止しても容量を確保してある間は課金の対象です
                <br>
                インスタンスを停止するには右クリックして停止、再開するには開始を押します。ただしこのときパブリックIPアドレスが変わります。
                <br>
                完全に削除するには削除を押せばよく、そうすると課金も完全に停止しますが復活する方法ないので注意しましょう

            </div>
            <div class="box">
                <h4>Amazon Linux</h4>
                Amazon LinuxはAWS社が提供しているLinuxのディストリビューションでRed Hat Enterprize Linux(RHEL)をベースとしたものでAWSを利用するためのコマンドが最初から入っていて便利です
                <br>
                <ul>
                    <li>Amazon Linux : RHEL6</li>
                    <li>Amazon Linux 2 : RHEL 7</li>
                </ul>
                をベースとしており、起動と停止、自動起動の設定などの方法、データベースがMySQLかMariaDBかなどの違いがあります。今回は新しい方を使います


            </div>


            </div>
            <div class="SSH itemWrapper">
                <h3>SSH接続</h3>
                <ol>
                    <li>
                        パブリックIPアドレスを確認します<br>
                    </li>
                    <li>
                        そのIPアドレスにSSH接続します。そのためにはmacではターミナルからSSHクライアントを起動します。ssh -i my-key.pem ec2-user@18.182.7.122　って入力します。
                        <br>
                        ただしこのときに作ったmy-key.pemのファイル設定が他のユーザーにも閲覧可能になっているとエラーが起きるので>chmod 400 my-key.pem って打ってください
                    </li>
                    <li>接続成功です。初回のみなんか聞かれるけどyesでいいです。</li>
                </ol>
                <div class="box">パブリックIPアドレスを固定化します
                    <ol>
                        <li>
                            ElasticIPを確保するために、タブからelastic ipを選択して
                        </li>
                        <li>IPアドレスをクリックしてアクションからElasticIPアドレスの関連付けをします。起動してるインスタンスを選択すれば大体わかります</li>

                    </ol>
                </div>

            </div>
            <div class="ipAddressAndPort itemWrapper">
                <h3>IPアドレスとポート番号深堀り</h3>
                <div>SSH接続された場合でも送信先に指定したIPアドレスにパケット化された情報を贈ります
                    <br>
                    新たなCIDR4が入ってきたときに小規模ならルートテーブルにそのことを追加すればよいのですが、大きいとそうは行きません、
                    <br>
                    そこでルーター同士が通信してルートテーブルの情報をやり取りして自動で更新するようにする仕組みがあります<strong class="red">ルーティングプロトコル</strong>です
                    <br>
                    大きく分けるとEGPとIGPの2つがあります
                    <ol>
                        <li>EGP
                            <br>
                            ISPインターネットサービスプロバイダーやAWSなどのある程度大きなネットワークはそのネットワークを管理するAS番号を持っています。
                            <br>
                            EGPではこのAS番号をやり取りして、どのネットワークの先にどのネットワークが接続されているのかを大まかにやり取りします

                        </li>
                        <li>
                            IGP
                            <br>
                            EGPの内部のルータ同士でルートテーブルの情報をやり取りします。つまりプロバイダーやAWSの内部での詳細なやり取りに使われます。
                            <br>
                            実際にはEGPではBGPなどがあり、そのネットワークの規模やセキュリティ条件によって使い分けられているようです

                        </li>
                        <li>まとめ
                            <br>
                            EGPで大体のネットワークを特定して、その内部をIGPで特定して通信経路を自動で確保するのがルーティングプロトコルでした
                        </li>
                    </ol>
                </div>

            </div>
            <div class="sshdAndPort itemWrapper">
                <h3>サーバー側のサービスとポート番号の関係</h3>
                <div>ここでターミナルを使ってSSH接続するとサーバーが応答してユーザー認証されるのが何故か疑問に思うでしょう
                    <br>
                    その理由は<div class="red">sshd</div>というプログラムがサーバー内部で動いているからです
                    <br>
                    ここでポートというものが登場します。一つのIPアドレスのホストに対して複数の通信をするために設けられている入り口のようなものです。
                    <br>
                    ポートにはそれぞれTCPとUDPが割り当てられています
                    <br>
                    sshdというプログラムもサーバー上で通信を待ち受けているアプリケーションでポートに結ぶつけられています
                    <br>
                    どのポートに結び付けられているかは　lsofコマンドを使って調べられます。ここで先程固定のElasticIPアドレス確保していた場合、そちらのIPアドレスにしなきゃだめです
                    <br>
                    ここでポートを見ると行の最後にlistenと書かれているのが待受をしているポート、ESTABLISHEDって書いてあるのが現在通信中のポートです。
                    <br>
                    どちらでもないのがUDPのポートです。(UDPにはデータの送受信の確認をしないので通信中という概念がない)
                    <br>
                    ここで*:22と書かれているのがすべてのIPアドレスを接続元として22は受け入れるよということ。逆に25を見ると接続元が127.0.0.1となっています。これはループバックアドレスと呼ばれ自分自身を表す特別なIPアドレスです。つまりこのポートは他のコンピュータからの通信を受け付けないという意味になります。
                    <br>
                    また、22が勝手に指定されているのはウェルノウンポートと呼ばれるものでSSHは22、SMTPは25、HTTPは80、HTTPSは443というように用途ごとに決まっています。
                    <br>
                    接続元にも適当なポート番号が使われますが、これをエフェメラルポートといいます。このポートは接続しているときだけ使われ、切断されると開放されます
                    <br>

                </div>
            </div>
            <div class="sectionWrapper">
                <div id="sec4">
                    <h3>ファイアウォールで接続制御する</h3>
                    <div class="itemWrapper">
                        IPアドレスとポート番号以外にもセキュリティを強めることができます。
                        <br>
                        その一つがパケットフィルタリングです
                        <br>
                        簡単に言うと流れるパケットを見て、通過していいものをフィルタリングするものです。
                        <br>
                        例として最も簡単なのはIPアドレスを見て特定のIPアドレスから以外のパケットを通過しないようにする設定などですね
                        <br>
                        多くの場合はDBに誰でもアクセスできてしまうと問題があるのでそのデータベースが入っているサーバーを3306番ぽーとカラの通信以外除去するように設定したりします

                    </div>
                    <div class="itemWrapper">
                        <h3>インスタンスのセキュリティグループ</h3>
                        <div>
                            実世界でパケットフィルタリングを構成するのはルーターやサーバー、もしくは専用のファイヤウォール機器です。しかしそれをAWS上ではセキュリティグループが担当します。
                            <br>
                            先ほどインスタンスを作成するときにWEB-SGというセキュリティグループを作成しました。
                            <br>
                            デフォルトではポート22に対してすべての通信を許可する。という設定がありますがそれ以外の設定はありません。
                            <br>
                            つまり
                            <br>
                            ポート22番はSSH接続できますが、それ以外のポートはできないということです。
                            <br>
                            つまり今後Webサーバソフトをインストールしていきますが、このままでは阻まれて通信できないということです
                            <br>
                            そこで今後はソフトウェアのインストールとともにセキュリティグループの構成も変更していきます
                            <br>
                            セキュリティグループの設定にはインバウンドとアウトバウンドという2つの向きがありますが、それはヨンデジのごとくです

                        </div>
                    </div>
                    <div class="itemWrapper">
                        <h3>まとめ</h3>
                        <div><ol>
                            <li>
                                パブリックサブネットの中に一台のインスタンスを作り、作成したインスタンスにはパブリックIPアドレスとプライベートIPアドレスを設定しました
                            </li>
                            <li>
                                ルーティングプロトコルによって自動でルートテーブルが組まれていることや、ポート、パケットフィルタリングとセキュリティグループについて学びました。
                            </li>
                        </ol></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</body>
</html>
